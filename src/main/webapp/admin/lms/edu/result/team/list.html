<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="/pages/admin/layout/common_layout">

<body>
<th:block layout:fragment="content">

<script>
$(function () {
	setToday();
	// 목록
	$('#frmList').submit(function (e) {
		e.preventDefault();
		dataList();
	});

	// 검색
	$('#frmList').submit();
});

function setToday(){ //검색일자 오늘로 설정
	var today = new Date();

    // 오늘의 날짜를 YYYY-MM-DD 형식으로 변환
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); // January는 0으로 시작하므로 +1
    var yyyy = today.getFullYear();

    today = yyyy + '-' + mm + '-' + dd;

    // 오늘의 날짜를 가지고 있는 input 요소를 찾아 기본값으로 설정
    document.getElementById('startDate').value = today;
}
// 목록
function dataList() {
	// 기본값 확인해서 전부 글로벌하게 덮어쓰기
	$('#dataTable').DataTable({
		autoWidth: false,
		lengthChange: false,
		searching: false,
		bDestroy: true,
		bInfo: false,
		responsive: true,
		processing: true,
		ordering: true,
		select: false,
		paging: true,
		pageLength: 10,
		fixedHeader: {
			header: false,
			footer: false,
		},
		ajax: {
			type: "get",
			url: gblAdminPath + "/lms/edu/result/team/listJson?" + $('#frmList').serialize(),
			dataType: "json",
			dataSrc: "data.list",
		},
		select: {
			style: "multi",
		},
		order: [0, "desc"],
		initComplete: dataTableInit,
		columns: [
			{ data: "playTeamIdx", className: "dt-body-center" },
			{ data: "trainTitle", className: "dt-body-center" },
			{ data: "teacherNm", className: "dt-body-center" },
			{ data: "startTime", className: "dt-body-center" },
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var playMinute = "-";
					if(row.playMinute){
						playMinute = row.playMinute;
					}
					return playMinute;
				}
			},
			{ data: "attemptMax", className: "dt-body-center" },
			{ data: "moduleCdCnt", className: "dt-body-center" },
			{ data: "team", className: "dt-body-center" },
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var mainWorker = "-";
					if(row.mainWorker){
						mainWorker = row.mainWorker;
					}
					return mainWorker;
				}
			},
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var subWorker = "-";
					if(row.subWorker){
						subWorker = row.subWorker;
					}
					return subWorker;
				}
			},
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var groundWorker = "-";
					if(row.groundWorker){
						groundWorker = row.groundWorker;
					}
					return groundWorker;
				}
			},
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var superWorker = "-";
					if(row.superWorker){
						superWorker = row.superWorker;
					}
					return superWorker;
				}
			},
			{
				data: null, searchable: false, orderable: true, className: 'dt-body-center',
				render: function (data, type, row, meta) {
					var url = "/api/edu/result/feedback/list?playTeamIdx=" + row.playTeamIdx;
					var playTeamResult = `<button onclick="window.open('${url}', '_blank');" class="waves-effect waves-light btn teal accent-4" ><i class="material-icons left">filter_none</i>보기</button>
						<button onclick="dataDelete(${row.playTeamIdx}, ${row.teacherIdx}, '팀별 훈련결과');" class="waves-effect waves-light btn red"><i class="material-icons left">delete</i>삭제</button>`;
					return playTeamResult;
				}
			},
		],
		createdRow: function (row, data, dataIndex) {
			// 각 행에 대한 이벤트를 여기서 추가
			$(row).on("click", function () {
				// 클릭 이벤트에 대한 동작을 여기에 추가
			});
		},
		
	});
}

// 데이터테이블 initComplete
function dataTableInit(settings, json) {
	if ($("#dataTable").DataTable().data().count() == 10000) {
		toast("데이터 조회를 10,000건으로 제한합니다.");
	}
	$("#dataTableTotCnt").text($("#dataTable").DataTable().data().count());
}

function excelDownload() {
    var url = gblAdminPath + "/lms/edu/result/team/download?" + $('#frmList').serialize();

    window.location.href = url;
}

//삭제
function dataDelete(playTeamIdx, memberIdx, title) {
	if (!playTeamIdx) {
		toast('잘못된 접근입니다.');
		return false;
	}
	if ($("input[name='sessionMemberRole']").val() != "SUPER" && $("input[name='sessionMemberIdx']").val() != memberIdx ){
		toast('삭제 권한이 없습니다.');
		return false;
	}
	
	$.confirm({
		theme : 'supervan',
		title : title + ' 삭제',
		content : '한번 삭제한 자료는 복구가 불가능합니다. <br /><br /> 삭제 하시겠습니까?',
		buttons : {
			확인 : function() {
				$.ajax({
					url  : gblAdminPath + '/lms/edu/result/team/delete',
					type : 'get',
					data : {
						'playTeamIdx' : playTeamIdx
					},
					dataType : 'json',
				}).done(function(data) {
					if(data.code == 0) {
						toast("정상적으로 처리되었습니다.");
						$('#dataTable').DataTable().ajax.reload(dataTableInit, false);
						//dataForm('');
					}
					else {
						toast(data.message);
					}
				}).fail(function(xhr) {
					if(typeof xhr.responseJSON.message != "undefined") {
						toast(xhr.responseJSON.message);
					}
				});
			},
			취소 : function() {
			}
		}
	});
}
</script>
		<div class="row">
			<div class="col s12 pd_box bg_lightblue h100">
				<div class="basic_top_searchbox">
					<form id="frmList" name="frmList" method="get" enctype="multipart/form-data">
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
						<input type="hidden" name="sessionMemberIdx" th:value="${session.memberIdx}" />
						<input type="hidden" name="sessionMemberRole" th:value="${session.memberRole}" />
						<div class="row">
							<!-- 검색창 -->
							
								<div class="input-field col s1 m1">
									<label for="startDate" class="">훈련 시작일자</label> <input
										id="startDate" name="startDate" type="date">
								</div>
								<div class="input-field col s1 m1">
									<label for="endDate" class="">훈련 종료일자</label> <input
										id="endDate" name="endDate" type="date">
								</div>
								
								<div class="col s10 m10 search_bar">

								<input name="scWord" type="text" class="browser-default"
									th:value="${param?.scWord}" placeholder="훈련명"> <input name="scKey2"
									type="hidden" th:value="${param?.scKey2}"> <input
									name="scTeam" type="hidden" th:value="${param?.scTeam}">
								<input name="type" type="hidden" value="memberList"> <input
									id="detailIdx" name="detailIdx" type="hidden"
									th:value="${param?.detailIdx}"> <input id="file"
									name="file" type="file" style="display: none;" />

								<button type="submit"
									class="waves-effect waves-light btn grey darken-2 z-depth-0 left">
									<i class="material-icons md-18 left">search</i> 검색
								</button>
								<div class="title left">
									전체 : <b id="dataTableTotCnt">0</b>
								</div>
								<div class="right">
									<a class="waves-effect waves-light green btn" onclick="excelDownload()">다운로드</a>
								</div>
							</div>
						</div>
					</form>
				</div>
			

				<!--
				<h2 class="h2_butt mt20 mb10">훈련자 목록</h2>
				-->
				<div class="table_type3">
					<table id="dataTable" class="striped centered highlight">
						<colgroup>
							<col width="80px" />
							<col width="auto" />
							<col width="120px" />
							<col width="150px" />
							<col width="120px" />
	 						<col width="120px" />
							<col width="120px" />
							<col width="120px" />
							<col width="120px" />
							<col width="120px" />
							<col width="120px" />
							<col width="100px" />
							<col width="180px" />
						</colgroup>
						<thead>
							<tr>
								<th>NO</th>
								<th>훈련명</th>
								<th>교수자</th>
								<th>훈련일시</th>
								<th>훈련시간(분)</th>
								<th>수행시도(횟수)</th>
								<th>수행모듈(개수)</th>
								<th>팀</th>
								<th>주작업자</th>
								<th>보조작업자</th>
								<th>지상작업자</th>
								<th>작업책임자</th>
								<th>비고</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
		</div>
</body>

</html>