<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<script>
	$(function () {
		var detailIdx = `[[${detailVo.detailIdx}]]`;
		studentList(detailIdx);
	});

	// 목록
	function studentList(detailIdx) {
		$("#dataTable").DataTable({
			autoWidth: false,
			lengthChange: false,
			searching: false,
			bDestroy: true,
			bInfo: false,
			responsive: true,
			processing: true,
			ordering: true,
			select: true,
			paging: false,
			scrollCollapse: false,
			scrollY: "174px",
			scrollX: "auto",
			fixedHeader: {
				header: false,
				footer: false,
			},
			ajax: {
				type: "get",
				url: gblAdminPath + "/lms/edu/result/studentList?detailIdx=" + detailIdx,
				dataType: "json",
				dataSrc: "data.list",
			},
			select: {
				style: "multi",
			},
			order: [0, "desc"],
			initComplete: dataTableInit1,
			columns: [
				{
					data: null,
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						return meta.settings._iDisplayStart + meta.row + 1;
					},
				},
				{ data: "memberId", className: "dt-body-center" },
				{ data: "memberNm", className: "dt-body-center" },
				{ data: "team", className: "dt-body-center" },
				{
					data: null, searchable: false, orderable: true, className: 'dt-body-center',
					render: function (data, type, row, meta) {
						var workRole = row.workRole;
						if (row.workRole == '1') {
							workRole = "주작업자";
						} else if (row.workRole == '2') {
							workRole = "보조작업자";
						} else if (row.workRole == '3') {
							workRole = "지상작업자";
						} else if (row.workRole == '4') {
							workRole = "작업책임자";
						}
						return workRole;
					}
				},
				{ data: "startTime", className: "dt-body-center" },
				{ data: "endTime", searchable: false, className: "dt-body-center" },
				{
					data: null, searchable: false, orderable: true, className: 'dt-body-center',
					render: function (data, type, row, meta) {
						var url = "/api/edu/result/feedback/list?playTeamIdx=" + row.playTeamIdx;
				        var playTeamResult = "<button class=\"waves-effect waves-light btn teal accent-4\" onclick=\"window.open('" + url + "', '_blank')\" ><i class=\"material-icons left\">filter_none</i>보기</button>";
						return playTeamResult;
					}
				},
			],
			createdRow: function (row, data, dataIndex) {
				// 각 행에 대한 이벤트를 여기서 추가
				$(row).on("click", function () {
					// 클릭 이벤트에 대한 동작을 여기에 추가
					$(this).closest('table').DataTable().rows('.selected').nodes().each((row)=> row.classList.remove('selected'));
					$(this).addClass('selected');
					moduleList(data.playIdx);
				});
			},
		});
	}


	// 데이터테이블 initComplete1
	function dataTableInit1(settings, json) {
		if ($("#dataTable").DataTable().data().count() == 10000) {
			toast("데이터 조회를 10,000건으로 제한합니다.");
		}
		
		if ($('#dataTable').DataTable().data().count() > 0) {
			$('#dataTable').DataTable().row(':first').nodes().to$().trigger('click');
		}else{
			moduleList();
		}
	}

	function moduleList(playIdx) {
		var txt = "";
		if (playIdx == undefined) {
			txt = `<ul><li><button><span>모듈수행없음</span></button></li></ul>`;
			// 리스트에 새로운 아이템 추가
			$(".module_list").empty();
			$(".module_list").html(txt);
		} else {
			$.ajax({
				url: gblAdminPath + "/lms/edu/result/moduleList?playIdx=" + playIdx,
				type: "GET",
				dataType: "json",
				dataSrc: "data.list",
			}).done(function (data) {
				// 기존 리스트를 비우기
				if (!data.data.list.length > 0) {
					txt = `<ul><li><button><span>수행 내역 없음</span></button></li></ul>`;
				} else {
					// 첫 번째 생성된 요소의 moduleCd 저장
					var firstModuleCd = null;
					txt += `<ul>`;
					$.each(data.data.list, function (index, item) {
						txt += `
							<li class="${index == 0? "on":""}">
								<button class="tab_btn " type="button" onclick="modulePlaytList('${playIdx}', '${item.moduleCd}'), click_btn_e2(this);">
									<span>${item.moduleTitle}</span>
								</button>
							</li>
							  `
						// 첫 번째 생성된 요소의 modulePlayIdx 저장
						if (index === 0) {
							firstModuleCd = item.moduleCd;
						}
					}); // for문 종료

					txt += `</ul>`;
				}

				// 리스트에 새로운 아이템 추가
				$(".module_list").empty();
				$(".module_list").html(txt);

				if (firstModuleCd !== null) {
					modulePlaytList(playIdx, firstModuleCd);
				} else {
					modulePlaytList(); //없으면 빈목록으로 초기화
				}
			})
				.fail(function () {
					toast("네트워크 또는 시스템 장애입니다.", 4000);
				});
		}
	}


	function modulePlaytList(playIdx, moduleCd) {
		var txt = "";
		if (playIdx == undefined || moduleCd == undefined) {
			$(".module_play_list").empty();
			txt += `<li class="module-item no-item"><span class="none_data">수행내역이 없습니다.</span></li>`
			$(".module_play_list").html(txt);
		} else {


			$.ajax({
				url: gblAdminPath + "/lms/edu/result/modulePlayList?playIdx=" + playIdx + "&moduleCd=" + moduleCd,
				type: "GET",
				dataType: "json",
				dataSrc: "data.list",
			})
				.done(function (data) {
					// 기존 리스트를 비우기
					$(".module_play_list").empty();
					if (!data.data.list.length > 0) {

						txt += `<li class="module-item no-item"><span class="none_data">수행내역이 없습니다.</span></li>`
						$(".module_play_list").html(txt);
					} else {
						// 첫 번째 생성된 요소의 modulePlayIdx 저장
						var firstModuleCd = null;
						var firstAttempt = null;

						// 새로운 데이터로 리스트 생성 및 추가
// 						$.each(data.data.list, function (index, item) {
						for (var i = 0; i < data.data.list.length; i++) {
							// 서버에서 받아온 날짜 문자열
// 							var startTime = new Date(item.moduleStartTime);
// 							var endTime = new Date(item.moduleEndTime);
							// 두 날짜 간의 차이 계산
// 							var timeDifference = item.moduleElapsedTime;
							// 차이를 시, 분, 초로 변환
							var seconds = data.data.list[i].moduleElapsedTime;
							var minutes = Math.abs(Math.floor(seconds / 60));
							var hours = Math.abs(Math.floor(minutes / 60));
							seconds = seconds % 60;
							minutes = minutes % 60;
							 
							var playTime = minutes + "분" + seconds + "초";
							txt += `

							 <li class="module-item ${i == 0? "on": ""}">
								 <button onclick="viewEventList('${data.data.list[i].moduleCd}', '${data.data.list[i].attempt}', '${playIdx}'), click_btn_e(this);">
									 <span class="number">
										${data.data.list[i].attempt}
									</span>
									<dl>
										<dt class="module-content ellipsis-2 ${data.data.list[i].moduleFailCnt < 1 ? "success" : "fail"}">
											${data.data.list[i].moduleFailCnt < 1 ? "작업 성공" : "작업 실패"}
										</dt>
										<dd>
											<span class="playtime">수행시간 : 
												 ${playTime}
											 </span>
										</dd>
									</dl>		
									 
								 </button>
							 </li>
						 `;
							// 리스트에 새로운 아이템 추가
							$(".module_play_list").html(txt);

							// 첫 번째 생성된 요소의 modulePlayIdx 저장
							if (i === 0) {
								firstModuleCd = data.data.list[i].moduleCd;
								firstAttempt = data.data.list[i].attempt;
							}
						}; // for문 종료
					}
					// for문이 끝난 후에 첫 번째 생성된 요소의 moduleCd를 사용하여 viewEventList 함수 실행
					if (firstModuleCd !== null) {
						viewEventList(firstModuleCd, firstAttempt, playIdx);
					} else {
						viewEventList(); //수행내역이 없으면 빈 테이블로 초기화
					}
				})
				.fail(function () {
					toast("네트워크 또는 시스템 장애입니다.", 4000);
				});
		}
	}


	// 이벤트 목록
	function viewEventList(moduleCd, attempt, playIdx) {
		$("#dataTable2").DataTable({
			autoWidth: false,
			lengthChange: false,
			searching: false,
			bDestroy: true,
			bInfo: false,
			responsive: true,
			processing: true,
			ordering: true,
			select: true,
			paging: false,
			scrollCollapse: false,
			scrollY: "348px",
			scrollX: "auto",
			fixedHeader: {
				header: false,
				footer: false,
			},
			ajax: {
				type: "get",
				url: gblAdminPath + "/lms/edu/result/viewEventList?moduleCd=" + moduleCd + "&attempt=" + attempt + "&playIdx=" + playIdx,
				dataType: "json",
				dataSrc: "data.list",
			},
			select: {
				style: "multi",
			},
			order: [1, "asc"],
			initComplete: dataTableInit2,
			columns: [
				{
					data: "null",
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						var txt;
						if (row.eventIdx == null) {
							txt = row.step;
						} else {
							if (row.eventId == null) {
								txt = "위험요인";
							} else {
								txt = "사고";
							}
						}
						return `${txt}`;
					},
				}, // 순서 또는 구분
				{
					data: "null",
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						var txt = '';
					    if (row.processPlayIdx != null) {
						    var seconds = row.processTiming;
						    var minutes = Math.floor(seconds / 60);
						    var hours = Math.floor(minutes / 60);
						    seconds = seconds % 60;
						    minutes = minutes % 60;

					        if (hours > 0) {
					            txt += hours + "시간 ";
					        }
					        if (minutes > 0) {
					            txt += minutes + "분 ";
					        }
					        if (seconds > 0) {
					            txt += seconds + "초";
					        } else if (txt === '') {
					            txt = '0초';
					        }
					    } else if(row.eventIdx != null){
						    var seconds = row.eventTiming;
						    var minutes = Math.floor(seconds / 60);
						    var hours = Math.floor(minutes / 60);
						    seconds = seconds % 60;
						    minutes = minutes % 60;

						    if (hours > 0) {
					            txt += hours + "시간 ";
					        }
					        if (minutes > 0) {
					            txt += minutes + "분 ";
					        }
					        if (seconds > 0) {
					            txt += seconds + "초";
					        } else if (txt === '') {
					            txt = '0초';
					        }
					    }
					    return `${txt}`;
					},
				}, // 발생시점
				{
					data: "null",
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						var txt;
						if (row.workRole == "1") {
							txt = "주작업자";
						} else if (row.workRole == "2") {
							txt = "보조작업자";
						} else if (row.workRole == "3") {
							txt = "지상작업자";
						} else if (row.workRole == "4") {
							txt = "작업책임자";
						} else {
							txt = row.workRole;
						}
						return `${txt}`;
					},
				}, // 역할
				{
					data: "null",
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						var txt;
						if (row.eventIdx == null) {
							txt = row.processContents; // 절차수행
						} else {
							if (row.eventId == null) { // 위험요인
								if (row.riskFactor == "1") {
									txt = "[감전"
								} else if (row.riskFactor == "2") {
									txt = "[추락"
								} else if (row.riskFactor == "3") {
									txt = "[부주의]"
								} else if (row.riskFactor == "4") {
									txt = "[작업부하]"
								}
								if (row.riskLevel == "1") {
									txt += " 주의]"
								} else if (row.riskLevel == "2") {
									txt += " 경고]"
								} else if (row.riskLevel == "3") {
									txt += " 위험]"
								}
								if (row.riskFactor == "1" && row.riskValue1 == "1") {
									txt += " 특고압선(22.9kV)"
								} else if (row.riskFactor == "1" && row.riskValue1 == "2") {
									txt += " COS/1차 측위/애자류 등"
								} else if (row.riskFactor == "1" && row.riskValue1 == "3") {
									txt += " 3상 인입선/인하선(380V)"
								} else if (row.riskFactor == "1" && row.riskValue1 == "4") {
									txt += " 저압인입선(220B)"
								}

								if (row.riskFactor == "2") {
									txt += " 불안정한 작업 위치"
								}

								if (row.riskFactor == "3") {
									txt += " 작업 방향과 다른 곳을" + row.riskValue1 + "초간 응시"
								}

								if (row.riskFactor == "4") {
									var str = row.riskValue1
									var firstChar = str[0];
									if (firstChar == '0') {
										txt += " 안정적인 자세";
									} else if (firstChar == '1') {
										txt += " 불안정한 자세";
									} else if (firstChar == '2') {
										txt += " 작업 자세가 근육에 부담";
									} else if (firstChar == '3') {
										txt += " 작업 자세가 근육에 과부하";
									} else if (firstChar == '4') {
										txt += " 작업 자세가 근육에 손상 우려";
									}

								}
							} else {
								txt += "[" + row.accidnetType + "] " + row.accidentBehavior;
							}
						}
						return `${txt}`;
					},
				}, // 순서 또는 구분
				{
					data: "null",
					className: "dt-body-center",
					render: function (data, type, row, meta) {
						var txt;
						if (row.taskTool != null || row.taskTool != undefined) {
							txt = row.taskTool;
						} else {
							txt = "-";
						}
						return `${txt}`;
					},
				}, // 작업도구
				{
					data: "null",
					className: "dt-body-center", //종류
					render: function (data, type, row, meta) {
						var txt = "";
						if (row.weather == "1") {
							txt += "맑음,";
						} else if (row.weather == "2") {
							txt += "폭염,";
						} else if (row.weather == "3") {
							txt += "소나기,";
						}
						if (row.c1 == "Y") {
							txt += "일반차량 충돌,";
						}
						if (row.c2 == "Y") {
							txt += "물웅덩이 생성,";
						}
						if (row.c3 == "Y") {
							txt += "통신기기 무단 발전,";
						}
						if (row.c4 == "Y") {
							txt += "가스관 파열,";
						}
						if (row.c5 == "Y") {
							txt += "CB 착오 투입,";
						}
						let txt_arr = txt.split(',');
						let txt_arr_result = '';
						txt_arr.forEach(val => {
							if (val != ''){
								txt_arr_result += `<span class="key_span">${val}</span>`
							}
						});
						return `<div class="key_box">${txt_arr_result}</div>`;
					},
				},//비고
			],
		});
	}


	// 데이터테이블 initComplete2
	function dataTableInit2(settings, json) {
		if ($("#dataTable2").DataTable().data().count() == 10000) {
			toast("데이터 조회를 10,000건으로 제한합니다.");
		}
	}

	function click_btn_e(target) {
		$(".module_play_list .module-item").removeClass("on");
		// target.addClass("on");
		target.parentNode.classList.add("on");
	}
	function click_btn_e2(target) {
		$(".result_tab_split_btn_wrap > ul > li").removeClass("on");
		// target.addClass("on");
		target.parentNode.classList.add("on");
	}
</script>

<input type="hidden" name="detailIdx" th:value="${detailVo?.detailIdx}" />
<h2 class="h2_butt mb10">기본 정보</h2>
<div class="first_info_box">
	<!-- 공통 - 명칭 -->
	<span class="tit_name">[[${detailVo.trainTitle}]]</span>
	<div class="info">
		<span class="tit">목표 : [[${detailVo.eduGoal}]]</span> <span class="cnt">설명 : [[${detailVo.eduDesc}]]</span>
		<span class="inst">교수자
			: [[${detailVo.teacherNm}]]</span> <span class="cate">분야 :
			[[${detailVo.eduCateNm}]]</span>
	</div>
</div>
<h2 class="h2_butt mt20 mb10">훈련자 목록</h2>
<div class="table_type3">
	<table id="dataTable" class="striped centered highlight" style="min-width: 1000px">
		<colgroup>
			<col width="80px" />
			<col width="auto" />
			<col width="180px" />
			<col width="50px" />
			<col width="150px" />
			<col width="180px" />
			<col width="180px" />
			<col width="200px" />
		</colgroup>
		<thead>
			<tr>
				<th>NO</th>
				<th>아이디</th>
				<th>성명</th>
				<th>팀</th>
				<th>역할</th>
				<th>훈련 시작시간</th>
				<th>훈련 종료시간</th>
				<th>팀별 훈련결과</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
</div>

<!--하단 모듈리스트, 테이블 박스-->
<div>
	<!--하단 테이블 제목, 설명-->
	<h2 class="h2_butt mt20">모듈 수행 내역</h2>
</div>

<div class="module_list result_tab_split_btn_wrap ">
	<ul>
		<li>
			<button>
				<span>...</span>
			</button>
		</li>
	</ul>
</div>


<div class="row">
	<!--하단 내용박스-->
	<div class="col s12 m12 l6 xl3 left_module_box training_result_box">
		<!--좌측 모듈리스트 박스-->
		<ul class="module_play_list list">
			<!-- 데이터가 없음 -->
			<li class="module-item no-item"><span class="none_data">수행
					내역이 없습니다.</span></li>
		</ul>
	</div>
	<!--좌측 모듈리스트 박스-->
	<div class="col s12 m12 l6 xl9 right_table_box">
		<!--우측 테이블 박스-->
		<div class="table_type3">
			<table id="dataTable2" class="striped centered highlight" style="min-width: 800px">
				<!--하단 우측 테이블-->
				<colgroup>
					<col width="80px" />
					<col width="80px" />
					<col width="80px" />
					<col width="auto" />
					<col width="100px" />
					<col width="200px" />
				</colgroup>
				<thead>
					<tr>
						<th>구분</th>
						<th>발생시점</th>
						<th>역할</th>
						<th>내용</th>
						<th>공구</th>
						<th>비고</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
	</div>
	<!--우측 테이블 박스-->
</div>
<!--하단 내용박스-->

</html>